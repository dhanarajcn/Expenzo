cmp-services:build_binary:
  stage: build-binary
  image: dishtechnology-ct-onstreamcmp.pe.jfrog.io/jenfewjfoehfiow
  script:
    - version=$(cat version.txt)
    - source scripts/pipelineUtils.sh;
    - echo $version
    - |
      if [[ "$CI_PROJECT_NAME" == "cmp-property" ]]; then
        echo "Running unit tests "
        sh ./scripts/run_unit_tests.sh  # Execute the unit test script
        TEST_EXIT_CODE=$?

        # Extract the pass percentage from the log file
        # PASS_PERCENTAGE=$(grep -oP 'coverage:\s*\K[0-9]{1,3}(\.[0-9]+)?(?=%)' "$CI_PROJECT_DIR/Coveragefiles/log.txt" | tail -n 1 || echo "N/A")
        COVERAGE_LINK="$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/file/Coveragefiles"

        if [[ $TEST_EXIT_CODE -ne 0 ]]; then
          if [[ $CI_COMMIT_REF_NAME == 'main' ]]; then
            SendMessageToHangoutsChat "Main -> *${CI_PROJECT_NAME}:${version}*\nFailed to *Run Unit Tests* - Pass Percentage: ${PASS_PERCENTAGE}\n [View Coverage Files]($COVERAGE_LINK)\nTriggered By ${GITLAB_USER_NAME}"
          elif [[ $CI_COMMIT_REF_NAME =~ ^release/ ]]; then
            SendMessageToHangoutsChat "Release -> *${CI_PROJECT_NAME}:${version}*\nFailed to *Run Unit Tests* - Pass Percentage: ${PASS_PERCENTAGE}\n [View Coverage Files]($COVERAGE_LINK)\nTriggered By ${GITLAB_USER_NAME}"
          fi
          exit 1
        else
          if [[ $CI_COMMIT_REF_NAME == 'main' ]]; then
            SendMessageToHangoutsChat "Main -> *${CI_PROJECT_NAME}:${version}*\nSuccessfully *Passed Unit Tests* - Pass Percentage: ${PASS_PERCENTAGE}\n[View Coverage Files]($COVERAGE_LINK)\nTriggered By ${GITLAB_USER_NAME}"
          elif [[ $CI_COMMIT_REF_NAME =~ ^release/ ]]; then
            SendMessageToHangoutsChat "Release -> *${CI_PROJECT_NAME}:${version}*\nSuccessfully *Passed Unit Tests* - Pass Percentage: ${PASS_PERCENTAGE}\n[View Coverage Files]($COVERAGE_LINK)\nTriggered By ${GITLAB_USER_NAME}"
          fi
        fi
      else
        echo "Skipping unit tests for service: $CI_PROJECT_NAME"
      fi


    - sh ./build.sh -b
    - ls -aL bin
    - |
      if [[ ! -e ./bin/$CI_PROJECT_NAME ]]; then
        if [[ $CI_COMMIT_REF_NAME == 'main' ]]; then
          SendMessageToHangoutsChat "Main -> *${CI_PROJECT_NAME}:${version}*\nFailed to *Build* the Binary Package - Triggered By ${GITLAB_USER_NAME}"
        elif [[ $CI_COMMIT_REF_NAME =~ *"release/"* ]]; then
          SendMessageToHangoutsChat "Release -> *${CI_PROJECT_NAME}:${version}*\nFailed to *Build* the Binary Package - Triggered By ${GITLAB_USER_NAME}"
        fi
        exit 1;
      fi

  artifacts:
    when: always
    paths:
      - $CI_PROJECT_DIR/bin/$CI_PROJECT_NAME
      - $CI_PROJECT_DIR/Coveragefiles

  rules:
    - !reference [cmp-services:update_version, rules]
    - if: $CI_COMMIT_BRANCH != 'main' && $CI_COMMIT_BRANCH !~ /^release/ && $CI_PROJECT_NAME != "browser"
